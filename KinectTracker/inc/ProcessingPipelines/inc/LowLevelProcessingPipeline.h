#ifndef PROCESSINGPIPELINE_H
#define PROCESSINGPIPELINE_H

#include "Erode.h"
#include "Dilate.h"
#include "Threshold.h"
#include "HOGFeatureDetector.h"
#include "InRange.h"
#include "SkinColorDetector.h"
#include <opencv2/opencv.hpp>
#include <QVector>
#include <QMap>
#include <QObject>

class ImageAnalyzer;
class QObject;

/**************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************/

class LowLevelProcessingPipeline : public QObject
{
    Q_OBJECT

public:
    LowLevelProcessingPipeline( QObject* parent = nullptr );
    virtual ~LowLevelProcessingPipeline();

    virtual void process( cv::Mat& input ) = 0;
    void setScreenshot( cv::Mat* screenshot );

    const QVector<ProcessingComponent*>& getComponents() const;
    QObject*                             getObjectByName( const QString& name );
    virtual cv::Mat*                     getProcessedImage();

protected:
    void registerComponent( ProcessingComponent* component,
                            const bool recursive );

    cv::Mat*                        mp_screenshot;
    QVector<ProcessingComponent*>   m_processingComponents;
    QMap<int, ProcessingComponent*> m_allComponents;
    int                             m_instanceCounter;
};


/**************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************/


class BackgroudSubtractionPipeline : public LowLevelProcessingPipeline
{
public:
    BackgroudSubtractionPipeline( QObject* parent );
    virtual ~BackgroudSubtractionPipeline();

    virtual void process( cv::Mat& input );
private:
    cv::BackgroundSubtractorMOG m_backgroundSubtractor;
    ErodePtr                    mp_erode;
};

/**************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************/

class BSPipeline : public LowLevelProcessingPipeline
{
public:
    BSPipeline( QObject* parent );
    virtual ~BSPipeline();

    virtual void process( cv::Mat& input );

private:
    ErodePtr     mp_erode;
    DilatePtr    mp_dilate;
    ThresholdPtr mp_threshold;

};

/**************************************************************************************************************************
**************************************************************************************************************************
**************************************************************************************************************************
**************************************************************************************************************************
**************************************************************************************************************************
**************************************************************************************************************************
**************************************************************************************************************************
**************************************************************************************************************************/


class HOGDetectionPipeline : public LowLevelProcessingPipeline
{
public:
    HOGDetectionPipeline( QObject* parent );
    virtual ~HOGDetectionPipeline();

    virtual void process( cv::Mat& input );

private:
    HogFeatureDetectorPtr   mp_HOGFeatureDetector;
    std::vector<cv::Point>  m_foundLocations;
    std::vector<cv::Rect>   m_rectangles;

};

/**************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************/


class SkinColorDetectionPipeline : public LowLevelProcessingPipeline
{
public:
    SkinColorDetectionPipeline( QObject* parent = nullptr );
    virtual ~SkinColorDetectionPipeline();

    virtual void process( cv::Mat& input );

private:
    SkinColorDetectorPtr mp_skinColorDetector;
    InRangePtr           mp_inRange;
};

/**************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************/

class SkinColorExplicitDefinedSkinRegionDetectionPipeline : public LowLevelProcessingPipeline
{
public:
    SkinColorExplicitDefinedSkinRegionDetectionPipeline( QObject* parent = nullptr);
    virtual ~SkinColorExplicitDefinedSkinRegionDetectionPipeline();

    virtual void process( cv::Mat& input );
    int          absoluteFrequency();
    cv::Mat*     getProcessedImage();

private:
    int     m_absoluteFrequency;
    cv::Mat m_processedImage;
};

typedef QSharedPointer<SkinColorExplicitDefinedSkinRegionDetectionPipeline> SkinColorExplicitDefinedSkinRegionDetectionPipelinePtr;

/**************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************/

class SkinColorHistogramDetectionPipeline : public LowLevelProcessingPipeline
{
    Q_OBJECT

public:
    SkinColorHistogramDetectionPipeline( QObject* parent = nullptr );
    virtual ~SkinColorHistogramDetectionPipeline();

    virtual void process( cv::Mat& input );
    void         setThreshold( const float threshold );

    bool             computeAndSaveROIHistogram( const cv::Mat& roi );
    int*             channels() const;
    int*             bins() const;
    float*           ranges() const;
    cv::Mat&         roi() const;
    cv::MatND&       histogram() const;
    bool             initialized() const;
    double           threshold() const;
    int              nonZeroPixels() const;
    float            nonZeroRelativeFrequency() const;
    void             reset();
    virtual cv::Mat* getProcessedImage();

signals:
    void thresholdChanged();
    void nonZeroPixelsChanged();
    void nonZeroRelativeFrequencyChanged();

private:
    cv::MatND         m_backprojection;
    mutable int       m_channels[3];
    mutable int       m_bins[3];
    mutable float     m_ranges[2];
    double            m_threshold;
    mutable cv::Mat   m_roi;
    mutable cv::MatND m_histogram;
    bool              m_initialized;
    int               m_nonZeroPixels;
    float             m_nonZeroRelativeFrequency;

private:
    Q_PROPERTY( double threshold MEMBER m_threshold
                READ threshold
                WRITE setThreshold
                NOTIFY thresholdChanged )

    Q_PROPERTY( int nonZeroPixels
                READ nonZeroPixels
                NOTIFY nonZeroPixelsChanged )

    Q_PROPERTY( float nonZeroRelativeFrequency
                READ nonZeroRelativeFrequency
                NOTIFY nonZeroRelativeFrequencyChanged )
};

typedef QSharedPointer<SkinColorHistogramDetectionPipeline> SkinColorHistogramDetectionPipelinePtr;

/**************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************
 **************************************************************************************************************************/

typedef QSharedPointer<LowLevelProcessingPipeline> LowLevelProcessingPipelinePtr;


#endif // PROCESSINGPIPELINE_H
